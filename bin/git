#!/bin/bash

set -e

IFS=', ' read -r -a grps <<< "$(id -G $USER)"
add_groups="${grps[*]/#/--group-add }"

app_name=$(basename $0)
image=dockash_${USER}_${app_name}:latest

if [[ "$(docker images -q ${image} 2> /dev/null)" == "" ]]; then
    pushd ${DOCKASH_SOURCE:-.}
    if [[ "$DOCKASH_SOURCE" == "" ]]; then
        repo=https://github.com/dan-elias/dockash
    else
        repo=.
    fi
    jupyter-repo2docker  \
        --image-name ${image} \
        --subdir src/${app_name} \
        $repo \
        echo
    popd
fi

config_volumes=()
for f in ${HOME}/{.gitconfig,.git-credentials}
do
    [[ -f $f]] || echo " " > $f
    config_volumes+=("--mount type=bind,source=$f,target=$f")
done

docker run \
    --rm \
    -i -t  --env LINES=`tput lines` --env COLUMNS=`tput cols` \
    --env HOME \
    --env USER \
    --user $(id -u ${USER}):$(id -g ${USER}) \
    $add_groups \
    ${config_volumes[@]} \
    --volume $(pwd):/work \
    --workdir="/work" \
    ${image} \
    ${app_name} "$@"

