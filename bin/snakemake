#!/bin/bash

set -e

IFS=', ' read -r -a grps <<< "$(id -G $USER)"
add_groups="${grps[*]/#/--group-add }"

app_name=$(basename $0)
image=dockash_${USER}_${app_name}:latest
dockerfile_url=https://raw.githubusercontent.com/dan-elias/dockash/master/src/${app_name}/Dockerfile 

if [[ "$(docker images -q ${image} 2> /dev/null)" == "" ]]; then
    echo $image not found - constructing it ...
    curl ${dockerfile_url} | docker build --tag ${image} - 
fi

config_volumes=()
for f in .gitconfig .git-credentials
do
    full_path=${HOME}/$f
    [ -f $full_path ] && config_volumes+=("--volume ${full_path}:${full_path}")
done


docker run \
    --rm \
    -i -t  \
    $add_groups \
    ${config_volumes[@]} \
    --volume /var/run/docker.sock:/var/run/docker.sock \
    --volume $(pwd):/work \
    --workdir="/work" \
    ${image} \
    ${app_name} $@
